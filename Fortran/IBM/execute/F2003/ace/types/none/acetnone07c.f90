!******************************************************************************
!*  ===========================================================================
!*
!*  DATE                       : 2006-08-01
!*
!*  PRIMARY FUNCTIONS TESTED   : Array Constructor Enhancements
!*
!*  SECONDARY FUNCTIONS TESTED : BOZ literals in AC's with no type specifier (complex)
!*
!*  REFERENCE                  : Feature Number 289053
!*
!*  REQUIRED COMPILER OPTIONS  :
!*
!*  KEYWORD(S)                 : typeless, boz, complex
!*  TARGET(S)                  :
!*  NUMBER OF TESTS CONDITIONS :
!*
!*  DESCRIPTION
!*
!*  Here we test boz literals masquerading as complex numbers.
!*
!*  Boz literals and Hollerith constants are typeless, so including them in an
!*  array constructor lacking a type specifier is a problem, because we don't
!*  know what type to assign to the AC.  The 2003 standard only allows them in
!*  one of three intrinsics (int, real, and cmplx) and in data statements.
!*  As an extension, they're allowed in some other contexts like those below.
!*  Because they are typeless, they cannot appear in a select type or be passed
!*  as unlimited polymorphic dummy args.
!*
!*  Note: Unlike Hollerith constants, boz literals are part of the standard.
!*
!*  There are companion tests to these in types/intrinsics.
!*
!* ============================================================================
!234567890123456789012345678901234567890123456789012345678901234567890123456789

program acetnone07c

  use, intrinsic :: ieee_features
  use, intrinsic :: ieee_arithmetic

  implicit none
  integer :: i

  complex(4) :: zArray4(4), exp4(4)
  complex(8) :: zArray8(4), exp8(4)
  integer(4) :: iArray(8)

  equivalence  (iArray(1),zArray4(1))

  exp4    = (/ (0.0_4, -0.0_4), (1.0_4, huge(0.0_4)), &
               (0.0_4, IEEE_VALUE(0.0_4, IEEE_POSITIVE_INF)), &
               (0.0_4, IEEE_VALUE(0.0_4, IEEE_QUIET_NAN)) /)

  zArray4 = (/(z'00000000', z'80000000'), (z'3f800000', z'7f7fffff'), &
              (z'00000000', z'7f800000'), (z'00000000', z'7fc00000')/)
  call check4(exp4, zArray4, 10_4)
  call check4(exp4, &
              (/(z'00000000', z'80000000'), (z'3f800000', z'7f7fffff'), &
                (z'00000000', z'7f800000'), (z'00000000', z'7fc00000')/), &
              11_4)

  zArray4 = (/((z'00000000',z'80000000'),(z'3f800000',z'7f7fffff'),i=1,1), &
              ((z'00000000',z'7f800000'),(z'00000000',z'7fc00000'),i=1,1)/)
  call check4(exp4, zArray4, 12_4)
  call check4(exp4, &
              (/((z'00000000',z'80000000'),(z'3f800000',z'7f7fffff'),i=1,1), &
                ((z'00000000',z'7f800000'),(z'00000000',z'7fc00000'),i=1,1)/), &
              13_4)

  ! Why mix <real>_<kind> with octal constants?  Here's why:
  ! The compiler assumes all bit positions of a boz literal are
  ! equally valid, whether they're leading zeroes or not.  In a binary or
  ! hexadecimal constant, this maps nicely onto bytes, but not so octal
  ! constants.  Ten octal digits make 30 bits (four bytes, so kind=4) and
  ! eleven make 33 (five bytes, so kind=8), so we can't specify the top
  ! two bits of an octal constant without doubling the size of the
  ! constant.  If we instead mix <real>_<kind> with octal constants, it
  ! gets the size right.

  zArray4 = (/(0.0_4,o'20000000000'), (1.0_4,o'17737777777'), &
              (0.0_4,o'17740000000'), (0.0_4,o'17760000000')/)
  call check4(exp4, zArray4, 20_4)
  call check4(exp4, &
              (/(0.0_4,o'20000000000'), (1.0_4,o'17737777777'), &
                (0.0_4,o'17740000000'), (0.0_4,o'17760000000')/), &
              21_4)

  zArray4 = (/((0.0_4,o'20000000000'), (1.0_4,o'17737777777'),i=1,1), &
              ((0.0_4,o'17740000000'), (0.0_4,o'17760000000'),i=1,1) /)
  call check4(exp4, zArray4, 22_4)
  call check4(exp4, &
              (/((0.0_4,o'20000000000'), (1.0_4,o'17737777777'),i=1,1), &
                ((0.0_4,o'17740000000'), (0.0_4,o'17760000000'),i=1,1) /), &
              23_4)

  zArray4 = (/(b'00000000000000000000000000000000', b'10000000000000000000000000000000'), &
              (b'00111111100000000000000000000000', b'01111111011111111111111111111111'), &
              (b'00000000000000000000000000000000', b'01111111100000000000000000000000'), &
              (b'00000000000000000000000000000000', b'01111111110000000000000000000000')/)
  call check4(exp4, zArray4, 30_4)
  call check4(exp4, &
              (/(b'00000000000000000000000000000000', b'10000000000000000000000000000000'), &
                (b'00111111100000000000000000000000', b'01111111011111111111111111111111'), &
                (b'00000000000000000000000000000000', b'01111111100000000000000000000000'), &
                (b'00000000000000000000000000000000', b'01111111110000000000000000000000')/), &
              31_4)

  zArray4 = (/((b'00000000000000000000000000000000', b'10000000000000000000000000000000'),i=1,1), &
              ((b'00111111100000000000000000000000', b'01111111011111111111111111111111'),i=1,1), &
              ((b'00000000000000000000000000000000', b'01111111100000000000000000000000'),i=1,1), &
              ((b'00000000000000000000000000000000', b'01111111110000000000000000000000'),i=1,1)/)

  call check4(exp4, zArray4, 32_4)
  call check4(exp4, &
              (/((b'00000000000000000000000000000000', b'10000000000000000000000000000000'),i=1,1), &
                ((b'00111111100000000000000000000000', b'01111111011111111111111111111111'),i=1,1), &
                ((b'00000000000000000000000000000000', b'01111111100000000000000000000000'),i=1,1), &
                ((b'00000000000000000000000000000000', b'01111111110000000000000000000000'),i=1,1)/), &
              33_4)

  exp8    = (/ (0.0_8, -0.0_8), (1.0_8, huge(0.0_8)), &
               (IEEE_VALUE(0.0_8, IEEE_POSITIVE_INF),IEEE_VALUE(0.0_8, IEEE_POSITIVE_INF)), &
               (IEEE_VALUE(0.0_8, IEEE_QUIET_NAN),IEEE_VALUE(0.0_8, IEEE_QUIET_NAN)) /)

  zArray8 = (/(z'0000000000000000', z'8000000000000000'), &
              (z'3ff0000000000000', z'7fefffffffffffff'), &
              (z'7ff0000000000000', z'7ff0000000000000'), &
              (z'7ff8000000000000', z'7ff8000000000000') /)
  call check8(exp8, zArray8, 40_4)
  call check8(exp8, &
              (/(z'0000000000000000', z'8000000000000000'), &
                (z'3ff0000000000000', z'7fefffffffffffff'), &
                (z'7ff0000000000000', z'7ff0000000000000'), &
                (z'7ff8000000000000', z'7ff8000000000000') /), &
              41_4)

  zArray8 = (/((z'0000000000000000', z'8000000000000000'), i=1,1), &
              ((z'3ff0000000000000', z'7fefffffffffffff'), i=1,1), &
              ((z'7ff0000000000000', z'7ff0000000000000'), i=1,1), &
              ((z'7ff8000000000000', z'7ff8000000000000'), i=1,1) /)
  call check8(exp8, zArray8, 42_4)
  call check8(exp8, &
              (/((z'0000000000000000', z'8000000000000000'), i=1,1), &
                ((z'3ff0000000000000', z'7fefffffffffffff'), i=1,1), &
                ((z'7ff0000000000000', z'7ff0000000000000'), i=1,1), &
                ((z'7ff8000000000000', z'7ff8000000000000'), i=1,1) /), &
              43_4)

  zArray8 = (/(0.0_8, o'1000000000000000000000'), &
              (o'377600000000000000000', o'777577777777777777777'), &
              (o'777600000000000000000', o'777600000000000000000'), &
              (o'777700000000000000000', o'777700000000000000000') /)

  call check8(exp8, zArray8, 50_4)
  call check8(exp8, &
              (/(0.0_8, o'1000000000000000000000'), &
                (o'377600000000000000000', o'777577777777777777777'), &
                (o'777600000000000000000', o'777600000000000000000'), &
                (o'777700000000000000000', o'777700000000000000000') /), &
              51_4)

  zArray8 = (/((0.0_8, o'1000000000000000000000'),i=1,1), &
              ((o'377600000000000000000', o'777577777777777777777'),i=1,1), &
              ((o'777600000000000000000', o'777600000000000000000'),i=1,1), &
              ((o'777700000000000000000', o'777700000000000000000'),i=1,1) /)
  call check8(exp8, zArray8, 52_4)
  call check8(exp8, &
              (/((0.0_8, o'1000000000000000000000'),i=1,1), &
                ((o'377600000000000000000', o'777577777777777777777'),i=1,1), &
                ((o'777600000000000000000', o'777600000000000000000'),i=1,1), &
                ((o'777700000000000000000', o'777700000000000000000'),i=1,1) /), &
              53_4)

  zArray8 = (/(b'0000000000000000000000000000000000000000000000000000000000000000', &
               b'1000000000000000000000000000000000000000000000000000000000000000'), &
              (b'0011111111110000000000000000000000000000000000000000000000000000', &
               b'0111111111101111111111111111111111111111111111111111111111111111'), &
              (b'0111111111110000000000000000000000000000000000000000000000000000', &
               b'0111111111110000000000000000000000000000000000000000000000000000'), &
              (b'0111111111111000000000000000000000000000000000000000000000000000', &
               b'0111111111111000000000000000000000000000000000000000000000000000') /)
  call check8(exp8, zArray8, 60_4)
  call check8(exp8, &
              (/(b'0000000000000000000000000000000000000000000000000000000000000000', &
                 b'1000000000000000000000000000000000000000000000000000000000000000'), &
                (b'0011111111110000000000000000000000000000000000000000000000000000', &
                 b'0111111111101111111111111111111111111111111111111111111111111111'), &
                (b'0111111111110000000000000000000000000000000000000000000000000000', &
                 b'0111111111110000000000000000000000000000000000000000000000000000'), &
                (b'0111111111111000000000000000000000000000000000000000000000000000', &
                 b'0111111111111000000000000000000000000000000000000000000000000000') /), &
              61_4)

  zArray8 = (/((b'0000000000000000000000000000000000000000000000000000000000000000', &
                b'1000000000000000000000000000000000000000000000000000000000000000'), &
               (b'0011111111110000000000000000000000000000000000000000000000000000', &
                b'0111111111101111111111111111111111111111111111111111111111111111'), &
               (b'0111111111110000000000000000000000000000000000000000000000000000', &
                b'0111111111110000000000000000000000000000000000000000000000000000'), &
               (b'0111111111111000000000000000000000000000000000000000000000000000', &
                b'0111111111111000000000000000000000000000000000000000000000000000'), i=1,1) /)
  call check8(exp8, zArray8, 62_4)
  call check8(exp8, &
              (/((b'0000000000000000000000000000000000000000000000000000000000000000', &
                  b'1000000000000000000000000000000000000000000000000000000000000000'), &
                 (b'0011111111110000000000000000000000000000000000000000000000000000', &
                  b'0111111111101111111111111111111111111111111111111111111111111111'), &
                 (b'0111111111110000000000000000000000000000000000000000000000000000', &
                  b'0111111111110000000000000000000000000000000000000000000000000000'), &
                 (b'0111111111111000000000000000000000000000000000000000000000000000', &
                  b'0111111111111000000000000000000000000000000000000000000000000000'), i=1,1) /), &
              63_4)

contains

  subroutine check4(exp, actual, ecode)
    complex (4) :: exp(:), actual(:)
    integer(4):: ecode, retcode, last, i
    last = ubound(exp,1)
    retcode = 0
    do i=1,last-1
       if (exp(i) /= actual(i) &
           .or. sign(1.0_4,real(exp(i))) /= sign(1.0_4,real(actual(i))) &
           .or. sign(1.0_4,aimag(exp(i))) /= sign(1.0_4,aimag(actual(i)))) then
          print *, "Expected #",i,"(4)", exp(i), ", got", actual(i)
          retcode = ecode
       end if
    end do
    if (actual(last) == actual(last)) then
       print *, "Expected QNaN(4), got", actual(last)
       retcode = ecode
    end if
    if (retcode /= 0) call zzrc(retcode)
  end subroutine check4

  subroutine check8(exp, actual, ecode)
    complex (8) :: exp(:), actual(:)
    integer(4):: ecode, retcode, last, i
    last = ubound(exp,1)
    retcode = 0
    do i=1,last-1
       if (exp(i) /= actual(i) &
           .or. sign(1.0_8,real(exp(i))) /= sign(1.0_8,real(actual(i))) &
           .or. sign(1.0_8,aimag(exp(i))) /= sign(1.0_8,aimag(actual(i)))) then
          print *, "Expected #",i,"(8)", exp(i), ", got", actual(i)
          retcode = ecode
       end if
    end do
    if (actual(last) == actual(last)) then
       print *, "Expected QNaN(8), got", actual(last)
       retcode = ecode
    end if
    if (retcode /= 0) call zzrc(retcode)
  end subroutine check8

end program acetnone07c
